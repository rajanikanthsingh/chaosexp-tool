# Metrics System Architecture - Fixed

## Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ChaosOrchestrator                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  NomadClientâ”‚    â”‚    MetricsCollector               â”‚   â”‚
â”‚  â”‚  (wrapper)  â”‚    â”‚                                   â”‚   â”‚
â”‚  â”‚             â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  _client â—„â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â–ºâ”‚ python-nomad Nomad client   â”‚  â”‚   â”‚
â”‚  â”‚    â”‚        â”‚    â”‚  â”‚                             â”‚  â”‚   â”‚
â”‚  â”‚    â”‚        â”‚    â”‚  â”‚ â€¢ .node.get_node()         â”‚  â”‚   â”‚
â”‚  â”‚    â–¼        â”‚    â”‚  â”‚ â€¢ .allocation.get_*()      â”‚  â”‚   â”‚
â”‚  â”‚ nomad.Nomad â”‚    â”‚  â”‚ â€¢ .job.get_job()           â”‚  â”‚   â”‚
â”‚  â”‚    client   â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow (Fixed)

### Before Fix âŒ
```
Orchestrator
    â”‚
    â”‚ self._nomad (NomadClient wrapper)
    â–¼
MetricsCollector
    â”‚
    â”‚ self.nomad_client.node.get_node()  âŒ ERROR!
    â–¼
AttributeError: 'NomadClient' object has no attribute 'node'
```

### After Fix âœ…
```
Orchestrator
    â”‚
    â”‚ self._nomad._client (underlying python-nomad client)
    â–¼
MetricsCollector
    â”‚
    â”‚ self.nomad_client.node.get_node()  âœ… SUCCESS!
    â–¼
Node metrics collected successfully
```

## Metrics Collection Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Chaos Experiment                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ BEFORE  â”‚      â”‚  DURING  â”‚      â”‚  AFTER  â”‚
   â”‚ metrics â”‚      â”‚ metrics  â”‚      â”‚ metrics â”‚
   â”‚         â”‚      â”‚ (12Ã—)    â”‚      â”‚         â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Compare    â”‚
                  â”‚  Metrics    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  JSON  â”‚      â”‚ Markdown â”‚     â”‚  HTML  â”‚
   â”‚ Report â”‚      â”‚  Report  â”‚     â”‚ Report â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  Chart.js     â”‚
                                  â”‚  Interactive  â”‚
                                  â”‚  Graphs       â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Target Types Support

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Target.kind                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  "allocation"  â”‚  Nomad allocation metrics             â”‚
â”‚                â”‚  â†’ collect_nomad_allocation_metrics() â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  "job"         â”‚  Nomad job metrics                    â”‚
â”‚                â”‚  â†’ collect_nomad_job_metrics()        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  "node"        â”‚  Nomad node metrics                   â”‚
â”‚                â”‚  â†’ collect_node_metrics()             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  "service"     â”‚  Service metrics via allocation       â”‚
â”‚                â”‚  â†’ Uses allocation_id from attributes â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## HTML Report Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HTML Report                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  ğŸ“Š Metrics Timeline                                 â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CPU Usage Over Time                           â”‚  â”‚
â”‚  â”‚  [Line chart: Before â†’ 12 during â†’ After]     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Memory Usage Over Time                        â”‚  â”‚
â”‚  â”‚  [Line chart: MB over time]                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Disk I/O Over Time                            â”‚  â”‚
â”‚  â”‚  [Dual-line: Read (green) + Write (orange)]   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Combined Metrics (CPU + Memory)               â”‚  â”‚
â”‚  â”‚  [Dual-axis chart]                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚
â”‚  ğŸ“Š Metrics Analysis                                 â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   CPU    â”‚  Memory  â”‚   Disk   â”‚  Status  â”‚      â”‚
â”‚  â”‚ Before:  â”‚ Before:  â”‚  Read:   â”‚  Before: â”‚      â”‚
â”‚  â”‚   15%    â”‚  512 MB  â”‚  100 MB  â”‚  ready   â”‚      â”‚
â”‚  â”‚ Peak:    â”‚ Peak:    â”‚  Write:  â”‚  After:  â”‚      â”‚
â”‚  â”‚   98%    â”‚ 1680 MB  â”‚   50 MB  â”‚  ready   â”‚      â”‚
â”‚  â”‚ After:   â”‚ After:   â”‚  Incr:   â”‚ âœ… Stable â”‚      â”‚
â”‚  â”‚   16%    â”‚  525 MB  â”‚ +790 MB  â”‚          â”‚      â”‚
â”‚  â”‚ âœ… Rec.  â”‚ âœ… Rec.  â”‚          â”‚          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling Flow

### Metrics Collection Error (Fixed)

**Before:**
```
collect_node_metrics()
    â”‚
    â”œâ”€â–º nomad_client.node.get_node(node_id)  âŒ AttributeError
    â”‚
    â””â”€â–º Return: {"error": "'NomadClient' object has no attribute 'node'"}
         â”‚
         â””â”€â–º HTML Report: Empty graphs (no data)
```

**After:**
```
collect_node_metrics()
    â”‚
    â”œâ”€â–º nomad_client.node.get_node(node_id)  âœ… Success
    â”‚
    â””â”€â–º Return: {
            "node_id": "...",
            "node_name": "...",
            "status": "ready",
            "resources": {...},
            "cpu": {...},
            "memory": {...}
        }
         â”‚
         â””â”€â–º HTML Report: Charts with data âœ…
```

## Code Change Visualization

```python
# orchestrator.py - BEFORE âŒ
class ChaosOrchestrator:
    def __init__(self):
        self._nomad = NomadClient(...)  # Our wrapper
        
        self._metrics = MetricsCollector(
            nomad_client=self._nomad     # âŒ Passes wrapper
        )
        
        # Later in run_experiment():
        during_metrics = self._metrics.collect_continuous_metrics(
            target_type=target.platform.lower(),  # âŒ No .platform
            target_id=target.identifier,
        )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# orchestrator.py - AFTER âœ…
class ChaosOrchestrator:
    def __init__(self):
        self._nomad = NomadClient(...)  # Our wrapper
        
        # Extract underlying client
        nomad_client_for_metrics = self._nomad._client if self._nomad else None
        
        self._metrics = MetricsCollector(
            nomad_client=nomad_client_for_metrics  # âœ… Passes python-nomad client
        )
        
        # Later in run_experiment():
        during_metrics = self._metrics.collect_continuous_metrics(
            target_type=target.kind.lower(),  # âœ… Uses .kind
            target_id=target.identifier,
        )
```

## Timeline of Events

```
User runs: chaosmonkey execute --chaos-type cpu-hog --target-id <node-id>
    â”‚
    â”œâ”€â–º [t=0s] Initialize orchestrator
    â”‚           â””â”€â–º Create MetricsCollector with python-nomad client âœ…
    â”‚
    â”œâ”€â–º [t=1s] Identify target (kind="node")
    â”‚           â””â”€â–º Use target.kind (not target.platform) âœ…
    â”‚
    â”œâ”€â–º [t=2s] Collect BEFORE metrics
    â”‚           â””â”€â–º nomad_client.node.get_node() âœ… Works!
    â”‚           â””â”€â–º Store baseline: CPU 15%, Memory 512MB
    â”‚
    â”œâ”€â–º [t=3s] Execute chaos experiment
    â”‚           â””â”€â–º CPU stress starts
    â”‚
    â”œâ”€â–º [t=3-63s] Collect DURING metrics (12 snapshots)
    â”‚           â””â”€â–º Every 5s: nomad_client.node.get_node() âœ…
    â”‚           â””â”€â–º Track: CPU rises to 98%, Memory to 1680MB
    â”‚
    â”œâ”€â–º [t=64s] Chaos experiment completes
    â”‚
    â”œâ”€â–º [t=65s] Collect AFTER metrics
    â”‚           â””â”€â–º nomad_client.node.get_node() âœ…
    â”‚           â””â”€â–º Store recovery: CPU 16%, Memory 525MB
    â”‚
    â”œâ”€â–º [t=66s] Compare metrics
    â”‚           â””â”€â–º Analysis: CPU recovered âœ…, Memory recovered âœ…
    â”‚
    â””â”€â–º [t=67s] Generate reports
                â”œâ”€â–º JSON: Full data structure
                â”œâ”€â–º Markdown: Text summary
                â””â”€â–º HTML: Interactive charts âœ…
                    â””â”€â–º Chart.js visualizes all data points
```

---

*Architecture diagram for metrics system with both bugs fixed*  
*Date: October 10, 2025*

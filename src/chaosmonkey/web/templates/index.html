<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChaosMonkey Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-radiation"></i> TMIS Chaos Monkey
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-tab="dashboard" onclick="showTab('dashboard', event)">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="nodes" onclick="showTab('nodes', event)">
                            <i class="fas fa-server"></i> Nodes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="execute" onclick="showTab('execute', event)">
                            <i class="fas fa-play-circle"></i> Execute Chaos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-tab="reports" onclick="showTab('reports', event)">
                            <i class="fas fa-chart-bar"></i> Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm ms-3 mt-1" onclick="manualRefresh()" title="Refresh data now">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </li>
                    <li class="nav-item">
                        <div class="form-check form-switch ms-3 mt-2">
                            <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked onchange="toggleAutoRefresh()">
                            <label class="form-check-label text-light" for="auto-refresh-toggle" style="cursor: pointer;">
                                <i class="fas fa-sync-alt"></i> Auto-refresh
                            </label>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="row">
                <div class="col-md-12">
                    <h2><i class="fas fa-tachometer-alt"></i> TMIS Chaos Monkey Dashboard</h2>
                    <p class="text-muted">Orchestrate and monitor chaos engineering experiments on your Nomad cluster</p>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Total Nodes</h6>
                            <h2 id="stat-total-nodes">-</h2>
                            <small id="stat-ready-nodes" class="text-success">Ready: -</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Drained Nodes</h6>
                            <h2 id="stat-drained-nodes" class="text-danger">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Total Experiments</h6>
                            <h2 id="stat-total-experiments">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Recovered Nodes</h6>
                            <h2 id="stat-recovered-nodes" class="text-success">-</h2>
                            <small class="text-muted">Eligible & Healthy</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-history"></i> Recent Experiments</h5>
                        </div>
                        <div class="card-body">
                            <div id="recent-experiments" class="list-group">
                                <div class="text-center text-muted">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-exclamation-triangle"></i> Available Chaos Types</h5>
                        </div>
                        <div class="card-body">
                            <div id="chaos-types-list" class="row">
                                <div class="text-center text-muted">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nodes Tab -->
        <div id="nodes-tab" class="tab-content" style="display:none;">
            <div class="row">
                <div class="col-md-12">
                    <h2><i class="fas fa-server"></i> Nodes & VMs</h2>
                    <div class="d-flex gap-3 align-items-center mb-3">
                        <div class="flex-grow-1">
                            <label for="source-select" class="form-label mb-1">Data Source:</label>
                            <select class="form-select" id="source-select" onchange="changeNodeSource()">
                                <option value="nomad">Nomad Client Nodes</option>
                                <option value="dora">Dora VMs</option>
                            </select>
                        </div>
                        <div id="dora-environment-container" style="display:none;" class="flex-grow-1">
                            <label for="dora-environment-select" class="form-label mb-1">Environment:</label>
                            <select class="form-select" id="dora-environment-select" onchange="loadNodes()">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="align-self-end">
                            <button class="btn btn-success me-2" id="recover-all-btn" onclick="recoverAllDrainedNodes()" title="Recover all drained nodes">
                                <i class="fas fa-heart-pulse"></i> Recover All Drained
                            </button>
                            <button class="btn btn-primary" onclick="manualRefresh(event)">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="nodes-search-input" placeholder="Search nodes by name, status, datacenter..." onkeyup="filterNodesTable()">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div id="nodes-table" class="table-responsive">
                                <div class="text-center text-muted">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execute Chaos Tab -->
        <div id="execute-tab" class="tab-content" style="display:none;">
            <div class="row">
                <div class="col-md-12">
                    <h2><i class="fas fa-play-circle"></i> Execute Chaos Experiment</h2>
                </div>
            </div>
            
            <!-- Random Chaos Section -->
            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-random"></i> Random Chaos Attack</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Execute random chaos experiments on random targets for true chaos engineering!</p>
                            <div class="d-flex gap-3 flex-wrap">
                                <button class="btn btn-warning" onclick="executeRandomChaosOnService()">
                                    <i class="fas fa-dice"></i> Random Chaos on Random Service
                                </button>
                                <button class="btn btn-warning" onclick="executeRandomChaosOnNode()">
                                    <i class="fas fa-dice-d6"></i> Random Chaos on Random Node
                                </button>
                                <button class="btn btn-danger" onclick="executeRandomChaosAnywhere()">
                                    <i class="fas fa-bolt"></i> Complete Random Chaos!
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Manual Chaos Configuration -->
            <div class="row mt-4">
                <div class="col-md-8 offset-md-2">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Manual Chaos Configuration</h5>
                        </div>
                        <div class="card-body">
                            <!-- Search Filter -->
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="chaos-search-input" 
                                           placeholder="Search chaos types, services, or nodes..." 
                                           onkeyup="filterChaosOptions()">
                                </div>
                            </div>
                            
                            <form id="chaos-form">
                                <div class="mb-3">
                                    <label for="chaos-type-select" class="form-label">Chaos Type</label>
                                    <select class="form-select" id="chaos-type-select" required>
                                        <option value="">Select a chaos type...</option>
                                    </select>
                                    <div id="chaos-type-description" class="form-text"></div>
                                </div>

                                <!-- Target Type Selection -->
                                <div class="mb-3">
                                    <label class="form-label">Target Type</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="target-type" id="target-type-manual" value="manual" checked>
                                        <label class="btn btn-outline-primary" for="target-type-manual">Manual Input</label>
                                        
                                        <input type="radio" class="btn-check" name="target-type" id="target-type-service" value="service">
                                        <label class="btn btn-outline-primary" for="target-type-service">Nomad Service</label>
                                        
                                        <input type="radio" class="btn-check" name="target-type" id="target-type-node" value="node">
                                        <label class="btn btn-outline-primary" for="target-type-node">Nodes (Nomad + VMs)</label>
                                        
                                        <input type="radio" class="btn-check" name="target-type" id="target-type-auto" value="auto">
                                        <label class="btn btn-outline-primary" for="target-type-auto">Auto Select</label>
                                    </div>
                                </div>

                                <!-- Manual Input -->
                                <div class="mb-3" id="manual-target-container">
                                    <label for="target-id-input" class="form-label">Target ID (Service/Node)</label>
                                    <input type="text" class="form-control" id="target-id-input" 
                                           placeholder="e.g., mobi-platform-account-service-job">
                                    <div class="form-text">Enter service or node ID manually</div>
                                </div>

                                <!-- Service Dropdown -->
                                <div class="mb-3" id="service-target-container" style="display:none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label for="service-select" class="form-label mb-0">Select Service(s)</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="select-all-services" onchange="toggleSelectAllServices()">
                                            <label class="form-check-label" for="select-all-services">
                                                Select All
                                            </label>
                                        </div>
                                    </div>
                                    <select class="form-select" id="service-select" multiple size="8">
                                        <option value="">Loading services...</option>
                                    </select>
                                    <div class="form-text">Choose one or more Nomad services/jobs to target (hold Ctrl/Cmd for multiple)</div>
                                </div>

                                <!-- Node Dropdown -->
                                <div class="mb-3" id="node-target-container" style="display:none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label for="node-select" class="form-label mb-0">Select Node(s)</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="select-all-node-targets" onchange="toggleSelectAllNodeOptions()">
                                            <label class="form-check-label" for="select-all-node-targets">
                                                Select All
                                            </label>
                                        </div>
                                    </div>
                                    <select class="form-select" id="node-select" multiple size="8">
                                        <option value="">Loading nodes...</option>
                                    </select>
                                    <div class="form-text">Choose one or more nodes to target (Nomad + VMs) (hold Ctrl/Cmd for multiple)</div>
                                </div>

                                <!-- Advanced Options Section -->
                                <div class="mb-3">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advanced-options" aria-expanded="false">
                                        <i class="fas fa-cog"></i> Advanced Options
                                    </button>
                                </div>

                                <div class="collapse" id="advanced-options">
                                    <div class="card card-body mb-3">
                                        <!-- General Options -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="duration-input" class="form-label">Duration (seconds)</label>
                                                <input type="number" class="form-control" id="duration-input" 
                                                       placeholder="120" min="1" max="3600">
                                                <div class="form-text">Override default experiment duration</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="latency-input" class="form-label">Network Latency (ms)</label>
                                                <input type="number" class="form-control" id="latency-input" 
                                                       placeholder="250" min="1" max="5000">
                                                <div class="form-text">For network latency experiments</div>
                                            </div>
                                        </div>

                                        <!-- k6 Load Testing Options -->
                                        <div id="k6-options" style="display:none;">
                                            <hr>
                                            <h6><i class="fas fa-chart-line"></i> k6 Load Testing Options</h6>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label for="virtual-users-input" class="form-label">Virtual Users</label>
                                                    <input type="number" class="form-control" id="virtual-users-input" 
                                                           placeholder="10" min="1" max="1000">
                                                    <div class="form-text">Concurrent users</div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="target-url-input" class="form-label">Target URL</label>
                                                    <input type="url" class="form-control" id="target-url-input" 
                                                           placeholder="http://service:8080">
                                                    <div class="form-text">Override auto-detected URL</div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="response-threshold-input" class="form-label">Response Threshold (ms)</label>
                                                    <input type="number" class="form-control" id="response-threshold-input" 
                                                           placeholder="500" min="1" max="10000">
                                                    <div class="form-text">Max acceptable response time</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="dry-run-check">
                                    <label class="form-check-label" for="dry-run-check">
                                        Dry Run (simulate without executing)
                                    </label>
                                </div>

                                <div class="alert alert-warning" role="alert">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Warning:</strong> Chaos experiments can disrupt services. 
                                    Ensure you have appropriate permissions and monitoring in place.
                                </div>

                                <button type="submit" class="btn btn-danger btn-lg w-100">
                                    <i class="fas fa-radiation"></i> Execute Chaos Experiment
                                </button>
                            </form>

                            <div id="execution-result" class="mt-4" style="display:none;">
                                <h5>Execution Result</h5>
                                <pre class="bg-dark text-light p-3 rounded" id="execution-output"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content" style="display:none;">
            <div class="row">
                <div class="col-md-12">
                    <h2><i class="fas fa-chart-bar"></i> Reports</h2>
                    <button class="btn btn-primary mb-3" onclick="refreshReports()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Node Drain Reports Section -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-server"></i> Node Drain Reports</h5>
                        </div>
                        <div class="card-body">
                            <div id="node-operations-list">
                                <div class="text-center text-muted">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Experiment Reports Section -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="fas fa-flask"></i> Chaos Experiment Reports</h5>
                        </div>
                        <div class="card-body">
                            <div id="reports-list">
                                <div class="text-center text-muted">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalTitle">Report Details</h5>
                    <div class="ms-auto me-2">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewFullHTMLReport()">
                                <i class="fas fa-external-link-alt"></i> View Full Report
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadReport('html')">
                                <i class="fas fa-download"></i> Download HTML
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="min-height: 400px;">
                    <ul class="nav nav-tabs" id="reportTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="json-tab" data-bs-toggle="tab" 
                                    data-bs-target="#json-content" type="button" role="tab" 
                                    aria-controls="json-content" aria-selected="true">JSON</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="markdown-tab" data-bs-toggle="tab" 
                                    data-bs-target="#markdown-content" type="button" role="tab"
                                    aria-controls="markdown-content" aria-selected="false">Markdown</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="html-tab" data-bs-toggle="tab" 
                                    data-bs-target="#html-content" type="button" role="tab"
                                    aria-controls="html-content" aria-selected="false">HTML</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="reportTabContent">
                        <div class="tab-pane fade show active" id="json-content" role="tabpanel" aria-labelledby="json-tab">
                            <pre class="bg-dark text-light p-3 rounded" style="min-height: 300px; max-height: 500px; overflow-y: auto; margin: 0;"><code id="report-json-content">Loading JSON data...</code></pre>
                        </div>
                        <div class="tab-pane fade" id="markdown-content" role="tabpanel" aria-labelledby="markdown-tab">
                            <pre class="bg-light p-3 rounded" style="min-height: 300px; max-height: 500px; overflow-y: auto; margin: 0;"><code id="report-markdown-content">Loading Markdown content...</code></pre>
                        </div>
                        <div class="tab-pane fade" id="html-content" role="tabpanel" aria-labelledby="html-tab">
                            <div id="report-html-content" style="min-height: 300px; max-height: 500px; overflow-y: auto; margin: 0;">
                                <div class="text-center p-5">
                                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3 text-primary fw-bold">Loading HTML report...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Node Operation Details Modal -->
    <div class="modal fade" id="nodeOperationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeOperationModalTitle">
                        <i class="fas fa-info-circle"></i> Node Operation Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="nodeOperationDetails">
                        <!-- Details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Percentage Drain Modal -->
    <div class="modal fade" id="percentageDrainModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-percent"></i> Drain Nodes by Percentage
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="drain-percentage" class="form-label">
                            Percentage of healthy nodes to drain: <strong><span id="drain-percentage-value">50</span>%</strong>
                        </label>
                        <input type="range" class="form-range" id="drain-percentage" 
                               min="1" max="100" value="50" 
                               oninput="document.getElementById('drain-percentage-value').textContent = this.value">
                    </div>
                    <div class="mb-3">
                        <p class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            This will randomly select <strong><span id="drain-count-preview">0</span></strong> nodes 
                            from the <strong><span id="total-nodes-preview">0</span></strong> available healthy nodes and drain them completely.
                        </p>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This operation will drain multiple nodes simultaneously. 
                        Ensure your cluster has enough capacity to handle the load migration.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="executePercentageDrain()">
                        <i class="fas fa-power-off"></i> Drain Nodes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/app.js"></script>
</body>
</html>

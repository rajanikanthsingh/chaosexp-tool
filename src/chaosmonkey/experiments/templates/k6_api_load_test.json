{
  "version": "1.0.0",
  "title": "k6 API Load Test",
  "description": "Load test REST API endpoints with health checks and response validation",
  "tags": ["api-test", "k6", "rest"],
  "steady-state-hypothesis": {
    "title": "API maintains health and performance under load",
    "probes": [
      {
        "type": "probe",
        "name": "check-api-health",
        "provider": {
          "type": "http",
          "url": "${target_url}${health_endpoint}",
          "method": "GET",
          "timeout": 10
        },
        "tolerance": [200, 201, 202]
      }
    ]
  },
  "method": [
    {
      "type": "action",
      "name": "run-api-load-test",
      "provider": {
        "type": "python",
        "module": "chaosmonkey.stubs.actions",
        "func": "run_k6_script",
        "arguments": {
          "script_text": "import http from 'k6/http';\nimport { check, sleep } from 'k6';\nimport { Counter, Rate, Trend } from 'k6/metrics';\n\n// Custom metrics\nlet apiErrors = new Counter('api_errors');\nlet apiSuccessRate = new Rate('api_success_rate');\nlet apiResponseTime = new Trend('api_response_time');\n\nexport let options = {\n  vus: ${virtual_users},\n  duration: '${duration_seconds}s',\n  thresholds: {\n    'http_req_duration': ['p(95)<${response_time_threshold}'],\n    'http_req_failed': ['rate<0.2'],\n    'api_success_rate': ['rate>0.8'],\n  },\n};\n\nexport default function() {\n  // Health check\n  let healthResponse = http.get('${target_url}${health_endpoint}');\n  check(healthResponse, {\n    'health check is 200': (r) => r.status === 200,\n  }) || apiErrors.add(1);\n  \n  // Main API endpoint - use health endpoint as main test target since it's more reliable\n  let response = http.get('${target_url}${health_endpoint}');\n  let success = check(response, {\n    'status is 200': (r) => r.status === 200,\n    'response time < ${response_time_threshold}ms': (r) => r.timings.duration < ${response_time_threshold},\n    'response has content': (r) => r.body.length > 0,\n  });\n  \n  apiSuccessRate.add(success);\n  apiResponseTime.add(response.timings.duration);\n  \n  if (!success) {\n    apiErrors.add(1);\n  }\n  \n  sleep(1);\n}",
          "options": {
            "thresholds": {
              "http_req_failed": ["rate<0.2"],
              "http_req_duration": ["p(95)<${response_time_threshold}"],
              "api_success_rate": ["rate>0.8"]
            }
          }
        }
      }
    }
  ],
  "rollbacks": []
}
Metadata-Version: 2.4
Name: chaosmonkey-cli
Version: 0.1.0
Summary: CLI orchestration layer for Nomad-driven Chaos Toolkit experiments
Author: ChaosMonkey Team
License: Apache-2.0
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: typer<1.0,>=0.9
Requires-Dist: rich<14,>=13
Requires-Dist: chaostoolkit-lib<2.0,>=1.42
Requires-Dist: python-nomad<3.0,>=2.1
Requires-Dist: pydantic<3.0,>=2.6
Requires-Dist: flask<4.0,>=3.0
Requires-Dist: flask-cors<5.0,>=4.0
Requires-Dist: requests<3.0,>=2.31
Requires-Dist: redis<6.0,>=5.0
Requires-Dist: python-dotenv<2.0,>=1.0
Requires-Dist: weasyprint<62.0,>=60.0
Provides-Extra: dev
Requires-Dist: pytest<9.0,>=8.2; extra == "dev"
Requires-Dist: pytest-cov<6.0,>=5.0; extra == "dev"
Requires-Dist: ruff<0.6.0,>=0.5.0; extra == "dev"
Requires-Dist: pyvmomi<9.0,>=8.0; extra == "dev"
Requires-Dist: ovirt-engine-sdk-python<5.0,>=4.6; extra == "dev"
Requires-Dist: prometheus-api-client; extra == "dev"

## ChaosMonkey Toolkit

ChaosMonkey combines the Chaos Toolkit orchestrator with HashiCorp Nomad discovery so you can design, launch, and review reliability experiments from a single UI or the CLI.

## Overview
- Web UI for targeting Nomad services, Nomad clients, and Dora VMs
- Chaos Toolkit experiments for CPU, memory, network, and load-testing scenarios (k6)
- Reports generated as JSON/Markdown/HTML for quick postmortems

## Quick Start
### Prerequisites
- Python 3.11+
- Nomad endpoint and token (set `NOMAD_ADDR`, `NOMAD_TOKEN`, optional `NOMAD_NAMESPACE`)
- Optional: Dora credentials (`DORA_HOST`, `DORA_USERNAME`, `DORA_PASSWORD`) for VM discovery

### Install & Run
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -e '.[dev]'

# required environment
export NOMAD_ADDR=http://127.0.0.1:4646
export NOMAD_TOKEN=your-token

# launch UI
python3 run_web_ui.py
```

Open <http://localhost:8080>. The UI shares the same interpreter as the CLI to avoid path issues.

### CLI Essentials
```bash
# discover services and nodes
chaosmonkey discover

# execute a dry-run experiment
chaosmonkey execute --chaos-type cpu-hog --target-id my-service --dry-run

# drain or recover a node
chaosmonkey drain-nodes --node-id <id>
chaosmonkey recover-nodes --node-id <id>
```

## Key Features
- Resilient service discovery that cleans CLI warnings before parsing JSON
- Combined node list that distinguishes Nomad clients (‚¨¢) and Dora VMs (üíª)
- Built-in experiment catalog covering infrastructure chaos and k6 load tests
- HTML/JSON/Markdown report viewer inside the UI

## Configuration
| Setting | How to supply |
| --- | --- |
| Nomad address / token | Environment variables or `chaosmonkey.yaml` (`nomad.address`, `nomad.token`) |
| Dora access (optional) | Environment variables or `chaosmonkey.yaml` under `platforms.dora` |
| Experiment paths | `chaosmonkey.yaml -> chaos.experiments_path` |

`.env.example` contains a ready-to-copy template. Configuration files override defaults; environment variables take precedence at runtime.

## Useful Endpoints
- `GET /api/discover/services` ‚Äì Nomad services and targets (flattened)
- `GET /api/discover/clients` ‚Äì Nomad clients and Dora VMs
- `GET /api/chaos-types` ‚Äì Available experiments
- `POST /api/execute` ‚Äì Run a Chaos Toolkit experiment

## Docs & Extras
- Web UI details: `docs/WEB_UI_GUIDE.md`
- Architecture reference: `docs/architecture.md`
- CLI-specific usage: `README-TOOLKIT-CLI.md`
- Go Nomad helper: `agents/nomad/`

## Roadmap
1. Harden experiment templates with production-grade actions
2. Expand UI controls for batching and scheduling experiments
3. Integrate richer telemetry and automated report publishing

## ‚öôÔ∏è Configuration

ChaosMonkey supports multiple configuration methods with the following priority (highest to lowest):

1. **Configuration file** (YAML/JSON) - `chaosmonkey.yaml`, `chaosmonkey.yml`, or `chaosmonkey.json`
2. **Environment variables** - Set via `.env` file or shell environment
3. **Default values** - Built-in defaults for local development

### Environment Variables

Create a `.env` file in the project root:

```bash
# Copy the example file
cp .env.example .env

# Edit the .env file with your favorite editor
# macOS users can use:
nano .env        # Terminal-based editor
open -e .env     # TextEdit
code .env        # VS Code (if installed)
```

Example `.env` contents:

```bash
# Nomad server address (required for real Nomad integration)
NOMAD_ADDR=http://your-nomad-server:4646

# Nomad authentication token (required if ACLs are enabled)
NOMAD_TOKEN=your-nomad-acl-token

# Optional: Nomad region
NOMAD_REGION=us-west-1

# Optional: Nomad namespace (defaults to 'default')
NOMAD_NAMESPACE=default
```

**‚ö†Ô∏è Security Note**: The `.env` file is already in `.gitignore` to prevent accidentally committing secrets. Never commit your actual credentials!

### Configuration File

Create a `chaosmonkey.yaml` file for more complex configuration:

```yaml
nomad:
  address: http://your-nomad-server:4646
  token: your-nomad-token
  region: us-west-1
  namespace: default

chaos:
  experiments_path: experiments
  reports_path: reports
  dry_run: false
```

Or use JSON format (`chaosmonkey.json`):

```json
{
  "nomad": {
    "address": "http://your-nomad-server:4646",
    "token": "your-nomad-token",
    "namespace": "default"
  },
  "chaos": {
    "experiments_path": "experiments",
    "reports_path": "reports"
  }
}
```

## üß™ Testing

```bash
# Activate virtual environment first (macOS)
source .venv/bin/activate

# Run tests
pytest

# Run tests with coverage
pytest --cov=chaosmonkey --cov-report=html
```

Tests stub external dependencies, so they succeed without a live Nomad cluster or Chaos Toolkit installed.

## üõ†Ô∏è Go Agent Scaffold (Optional)

The Go module provides a lightweight Nomad helper meant to run as a Nomad job for deeper cluster integration.

### Prerequisites

Ensure Go 1.22+ is installed (see macOS Installation section above).

### Setup and Run

```bash
# Navigate to the agent directory
cd agents/nomad

# Download dependencies
go mod tidy

# Run the chaos agent
go run ./cmd/chaos-agent discover

# Run tests
go test ./...
```

### macOS-Specific Notes

- **Network Issues**: If `go mod tidy` fails with connection errors, check your network connection or try again later.
- **Go Environment**: Verify Go is properly configured:
  ```bash
  go env GOPATH
  go env GOROOT
  ```

## üîß Troubleshooting (macOS)

### CLI Command Not Found

If you get `command not found: chaosmonkey`, make sure:

1. You've installed the package: `pip install -e '.[dev]'`
2. Your virtual environment is activated: `source .venv/bin/activate`
3. See the consolidated "CLI Quick Reference" at the end of this README for alternative invocations (module-based examples).

### Python Version Issues

```bash
# Check Python version (must be 3.11+)
python3 --version

# If you have multiple Python versions, specify the version:
python3.13 -m venv .venv
```

### Permission Errors

```bash
# If you encounter permission errors, don't use sudo with pip
# Instead, make sure you're in a virtual environment
source .venv/bin/activate
```

### Import Errors

```bash
# Reinstall dependencies
pip install --upgrade pip
pip install -e '.[dev]'
```

## üó∫Ô∏è Roadmap

1. **CLI Baseline (current)** ‚Äì stub integrations, experiment templates, reporting artifacts.
2. **Hardening & Automation** ‚Äì implement real chaos actions, CI pipelines, richer telemetry capture.
3. **UI Evolution** ‚Äì expose orchestrator via API, deliver a Reliably-inspired experience for experiment design and insights.

## üñºÔ∏è Architecture Diagram

This repository includes a draw.io (diagrams.net) XML diagram representing the ChaosMonkey architecture. The diagram file is available at `docs/architecture.drawio`.

How to open

- In the browser: go to https://app.diagrams.net/ and choose File ‚Üí Open from Device, then select `architecture.drawio`.
- In VS Code: use the 'Draw.io Integration' extension and open the file.

Notes

- The diagram includes: Your Machine (CLI), Web UI, Redis, chaosmonkey CLI (subprocess), Nomad Cluster, Target Node, Service under test, and Chaos Stress Job.
- Connectors show the Web UI using Redis and optionally invoking the CLI via subprocess (dashed). The CLI executes jobs through the Nomad Cluster.

If you'd like layout tweaks or a PNG export, I can generate and attach that next.

See `docs/architecture.md` for a deeper breakdown of components and flow.

## ‚öôÔ∏è Installation & Quick Start (macOS)

Follow these steps to get a working development environment on macOS and run the CLI and Web UI.

### Prerequisites

1. **Python 3.11+** (Python 3.13+ recommended)
  ```bash
  # Check your Python version
  python3 --version
   
  # Install Python via Homebrew if needed
  brew install python@3.13
  ```

2. **Go 1.22+** (optional, only needed for the Nomad agent)
  ```bash
  # Check if Go is installed
  go version
   
  # Install Go via Homebrew if needed
  brew install go
  ```

3. **Node.js and npm** (optional, for K6 installation via npm)
  ```bash
  # Check if Node.js is installed
  node --version && npm --version
   
  # Install Node.js via Homebrew if needed
  brew install node
  ```

4. **Redis** (optional, recommended for full Web UI functionality)
  ```bash
  brew install redis
  brew services start redis
  ```

### Setup Steps

```bash
# 1. Clone and navigate to the repository
git clone https://github.com/xperi-tmis/chaosmonkey.git
cd chaosmonkey

# 2. Create and activate virtual environment
python3 -m venv .venv
source .venv/bin/activate

# 3. Install the CLI and dev requirements
pip install -e '.[dev]'
```

### Quickstart ‚Äî CLI (local)

See the consolidated "CLI Quick Reference" at the end of this README for the most-used commands and examples.



#### 3. Dora (vSphere) VM Prerequisites (optional)

If you want to use the Web UI's Dora-based VM discovery (vSphere inventory), the Web UI includes a Dora client that queries a Dora API. Provide the following environment variables or add them to `chaosmonkey.yaml` under `platforms.dora`:

Environment variables (recommended for quick setup):

```bash
# Dora API / auth host and ports
export DORA_HOST=hostname
export DORA_API_PORT=8000
export DORA_AUTH_PORT=51051

# Dora credentials (required)
export DORA_USERNAME=your-dora-username
export DORA_PASSWORD=your-dora-password
```

Notes / requirements:
- The Web UI authenticates to Dora via the auth port and fetches a short-lived token. Ensure the Web UI host/network can reach both `DORA_AUTH_PORT` and `DORA_API_PORT` on `DORA_HOST`.
- Dora client defaults and environment mappings are defined in `src/chaosmonkey/platforms/dora/client.py`. The client expects the Dora API to expose `/v1/GetLoginToken/` for authentication and `/v1/GetVirtualMachines/` and `/v1/GetHypervisors/` endpoints.
- If your Dora deployment uses different paths or auth mechanisms, configure `platforms.dora` in `chaosmonkey.yaml` instead of environment variables.
- Dora API responses are proxied into the UI; large environments may take longer to load. Use the `hostfilter` and environment config to restrict results.

### üåê Access the Dashboard

Once started, open your browser:

```
http://localhost:8080
```

## Dora VM Discovery

The Web UI can query a Dora API to list vSphere hypervisors and virtual machines for discovery and targeting. This section explains how to configure and use the Dora integration from the Web UI and the API.

Key points:
- The Dora client is implemented in `src/chaosmonkey/platforms/dora/client.py` and expects Dora endpoints for authentication and inventory lookup.
- You can configure Dora via environment variables or in `chaosmonkey.yaml` under `platforms.dora`.
- The Web UI exposes an HTTP endpoint to fetch Dora environment data which the UI uses to render hypervisors and VMs.

Configuration examples

Environment variables (quick setup):

```bash
export DORA_HOST=hostname
export DORA_API_PORT=8000
export DORA_AUTH_PORT=51051
export DORA_USERNAME=your-dora-username
export DORA_PASSWORD=your-dora-password
```

`chaosmonkey.yaml` snippet (file-based configuration):

```yaml
platforms:
  dora:
    host: hostname
    api_port: 8000
    auth_port: 51051
    username: your-dora-username
    password: your-dora-password
```

Using the API

The Web UI exposes the following route to retrieve Dora environment data:

- GET /api/discover/dora

Query parameters:
- `environment` (optional) ‚Äî environment name as defined in the Dora client mapping (defaults to `Dev1` in the example config)
- `debug` (optional) ‚Äî when `true` returns raw Dora response for debugging

Example cURL (debug output):

```bash
curl -s "http://localhost:8080/api/discover/dora?environment=Dev1&debug=true"
```

Tips & troubleshooting

- Ensure the Web UI host can reach both the Dora auth and API ports on the `DORA_HOST` (firewalls and VPNs often block these).
- The Dora client authenticates using `/v1/GetLoginToken/{username}/{password}` and then calls `/v1/GetVirtualMachines/` and `/v1/GetHypervisors/` with the returned token.
- For large inventories, use host filters (see `src/chaosmonkey/platforms/dora/client.py` and `DORA_ENVIRONMENTS` mapping) to restrict results returned to the UI.
- If authentication fails, verify credentials and that the Dora auth port is reachable. Enable `debug=true` in the API call to see raw responses.

### üêõ Fixed Issues

#### ‚úÖ Issue 1: Total Nodes Loading Slow
**Fixed**: Changed from CLI parsing to direct Nomad API calls
- Now uses `python-nomad` library directly
- Much faster response time
- No CLI subprocess overhead

#### ‚úÖ Issue 2: Total Nodes Not Clickable
**Fixed**: The stats are now informational displays
- Shows total nodes count
- Shows ready nodes count
- Shows drained nodes count
- Click on "Nodes" tab in navigation to see full node list

#### ‚úÖ Issue 3: Available Chaos Types Showing Blank
**Fixed**: Improved chaos type loading
- Reads templates from `src/chaosmonkey/experiments/templates/`
- Displays icons and descriptions
- Click on chaos type cards to navigate to execute page

#### ‚úÖ Issue 4: Drain Not Working Due to Invalid Hex Codes
**Fixed**: Complete node drain implementation
- Now passes full node ID (not truncated with `...`)
- Uses Nomad HTTP API directly
- Proper payload format with `DrainSpec`
- Handles node ID cleaning automatically
- Better error messages

#### ‚úÖ Issue 5: No Chaos Types in Execute Tab
**Fixed**: Execute chaos tab now shows:
- All available chaos types in dropdown
- Descriptions for each type
- Proper icons
- Target ID input
- Dry-run checkbox

### üìä Dashboard Features

#### Dashboard Tab
- **Total Nodes**: Click "Nodes" tab to see details
- **Drained Nodes**: Shows count of nodes in drain mode
- **Total Experiments**: Number of chaos experiments run
- **Success Rate**: Percentage of successful experiments
- **Recent Experiments**: Last 5 experiments with status
- **Available Chaos Types**: Click cards to execute chaos

#### Nodes Tab
- **Real-time node status**: Updated from Nomad API
- **Node details**: Name, ID, datacenter, resources
- **Drain/Enable buttons**: One-click node operations
- **Full node IDs**: Hover over truncated IDs to see full ID
- **Loading indicators**: Shows spinner during operations

#### Execute Chaos Tab
- **Chaos Type Dropdown**: All available types
  - üî• CPU Hog
  - üíæ Memory Hog
  - üêå Network Latency
  - üì¶ Packet Loss
  - üíÄ Host Down
  - üíø Disk I/O
- **Target ID**: Optional service/node identifier
- **Dry Run**: Test mode without actual execution
- **Execution Output**: Real-time results display

#### Reports Tab
- **All experiment reports**: Listed newest first
- **Status badges**: Visual status indicators
- **View Details**: Opens multi-format report viewer
  - JSON: Raw data
  - Markdown: Human-readable
  - HTML: Formatted report
- **Direct Links**: Open HTML reports in new tab

### üîß Troubleshooting

#### Problem: "Command not found: python"
**Solution**: Use `python3` instead
```bash
python3 run_web_ui.py
```

#### Problem: "Module not found: flask"
**Solution**: Install dependencies
```bash
pip install flask flask-cors requests
```

#### Problem: "No nodes showing"
**Solution**: Check Nomad connection
```bash
# Verify environment variables
echo $NOMAD_ADDR
echo $NOMAD_TOKEN

# Test connection
curl -H "X-Nomad-Token: $NOMAD_TOKEN" $NOMAD_ADDR/v1/nodes
```

#### Problem: "403 Permission denied" when draining
**Solution**: Your Nomad token needs elevated permissions

Add this policy:
```hcl
node {
  policy = "write"
}
```

#### Problem: "Chaos types not showing in Execute tab"
**Solution**: 
1. Check that templates exist in `src/chaosmonkey/experiments/templates/`
2. Verify files:
   - `generic_cpu_hog.json`
   - `generic_memory_hog.json`
   - `generic_network_latency.json`
   - `generic_packet_loss.json`
   - `generic_host_down.json`
   - `generic_disk_io.json`

#### Problem: "Node drain fails with invalid ID"
**Solution**: Fixed in latest code
- Now automatically cleans node IDs
- Handles truncated IDs (`...`)
- Passes full ID to API

### üéØ Usage Examples

#### Example 1: View All Nodes

1. Click "Nodes" tab in navigation
2. Wait for nodes to load (should be fast now!)
3. See full list with status, resources, drain state

#### Example 2: Drain a Node

1. Go to "Nodes" tab
2. Find the node you want to drain
3. Click red "Drain" button
4. Confirm the action
5. Watch the spinner while draining
6. Node will show "Drain: Yes" when complete

#### Example 3: Execute CPU Hog Chaos

1. Go to "Execute Chaos" tab
2. Select "üî• CPU Hog" from dropdown
3. Enter target service ID (e.g., `mobi-platform-account-service-job`)
4. Check "Dry Run" for testing
5. Click "Execute Chaos Experiment"
6. View output in the result section

#### Example 4: View Experiment Reports

1. Go to "Reports" tab
2. Click "View Details" on any report
3. Switch between JSON/Markdown/HTML tabs
4. Or click "HTML" button to open in new tab

### üìù Quick Reference

#### API Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/discover/clients` | GET | List all nodes |
| `/api/chaos-types` | GET | List chaos types |
| `/api/execute` | POST | Run chaos experiment |
| `/api/node/drain` | POST | Drain a node |
| `/api/node/eligibility` | POST | Enable/disable node |
| `/api/reports` | GET | List all reports |
| `/api/reports/{id}` | GET | Get specific report |

#### Environment Variables

| Variable | Required | Example |
|----------|----------|---------|
| `NOMAD_ADDR` | Yes | `http://nomad-dev-fqdn:4646` |
| `NOMAD_TOKEN` | Yes | `your-token-here` |
| `NOMAD_NAMESPACE` | No | `default` |

#### Keyboard Shortcuts

- `Ctrl+C` in terminal: Stop the web server
- `F5` in browser: Refresh dashboard
- `Ctrl+R` in browser: Reload page

### üé® UI Improvements Summary

1. ‚úÖ **Faster Loading**: Direct API calls instead of CLI
2. ‚úÖ **Better UX**: Loading spinners and progress indicators
3. ‚úÖ **Working Drain**: Proper node ID handling
4. ‚úÖ **Chaos Types**: All types visible and selectable
5. ‚úÖ **Clear Feedback**: Success/error messages with details
6. ‚úÖ **Responsive**: Works on desktop and tablet
7. ‚úÖ **Professional**: Clean, modern Bootstrap design

### üö¶ Status Indicators

#### Node Status Colors
- üü¢ **Green**: Ready and healthy
- üî¥ **Red**: Down or unavailable
- üü° **Yellow**: Initializing or maintenance

#### Drain Status
- üü¢ **No**: Node is eligible for allocations
- üî¥ **Yes**: Node is draining or drained

#### Experiment Status
- üü¢ **completed**: Experiment succeeded
- üî¥ **failed**: Experiment failed
- üü° **dry-run**: Simulation only

### üìö Additional Documentation

- Full Guide: `docs/WEB_UI_GUIDE.md`
- Architecture: `docs/architecture.md`
- Node Drain: `docs/NODE_DRAIN.md`
- Reports: `docs/REPORTS_GUIDE.md`

### üí° Pro Tips

1. **Start with Dry-Run**: Always test chaos experiments in dry-run mode first
2. **Monitor Before Chaos**: Open the Nodes tab before running experiments
3. **Check Reports**: Review experiment reports to understand impact
4. **Use Full Node IDs**: The UI now handles full IDs correctly
5. **Set Permissions**: Ensure your Nomad token has required permissions
6. **Browser Console**: Open DevTools (F12) to see detailed API calls

---

**Need Help?** Check the main documentation or examine the browser console for detailed error messages.

## üñ•Ô∏è CLI Quick Reference

This section collects the most-used `chaosmonkey` CLI commands in one place.

### Installation (dev)

```bash
# Create and activate virtual environment
python3 -m venv .venv
source .venv/bin/activate

# Install the CLI and dev requirements
pip install -e '.[dev]'
```

### Discovery

```bash
chaosmonkey discover
```

### Drain / Recover Nodes

```bash
# List available nodes
chaosmonkey drain-nodes

# Drain a specific node with confirmation
chaosmonkey drain-nodes --node-id <node-id>

# Drain with custom deadline and skip confirmation
chaosmonkey drain-nodes --node-id <node-id> --deadline 600 --yes

# Dry run to see what would be drained
chaosmonkey drain-nodes --node-id <node-id> --dry-run

# Recover nodes
chaosmonkey recover-nodes
chaosmonkey recover-nodes --node-id <node-id> --yes
chaosmonkey recover-nodes --dry-run
```

### Execute Experiments

```bash
# Dry run
chaosmonkey execute --dry-run

# Execute network latency experiment
chaosmonkey execute --chaos-type network-latency

# Execute with overrides
chaosmonkey execute --chaos-type network-latency --duration 40 --latency-ms 300
```

### Misc

```bash
# Get clients/nodes
chaosmonkey discover --clients

# Useful piping example
chaosmonkey drain-nodes | grep <node-name>

# Dry run (safe, generates artifacts without real chaos)
chaosmonkey execute --dry-run

# Execute network latency experiment
chaosmonkey execute --chaos-type network-latency

# Execute with custom duration and latency
chaosmonkey execute --chaos-type network-latency --duration 40 --latency-ms 300

# Run k6 load test with 50 virtual users
chaosmonkey execute --chaos-type k6-load-test --virtual-users 50 --target-url http://my-service:8080

# Run k6 spike test with custom response threshold
chaosmonkey execute --chaos-type k6-spike-test --response-threshold 1000

# Test API endpoints with health checks
chaosmonkey execute --chaos-type k6-api-test --target-id my-api-service --virtual-users 25

# Test database-backed services
chaosmonkey execute --chaos-type k6-database-test --target-id my-db-service --duration 180
```


